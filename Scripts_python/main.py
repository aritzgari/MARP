#!/usr/bin/env python
#=== IMPORTS ===
import snap7
import time

#=== CONSTANTES ===
tiempo_bucle = 1 #En segundos

#Datos de conexion
IP = "192.168.0.1"
RACK = 0
SLOT = 1

#=== VARIABLES ===
#Definimos PLC como cliente de Snap7
global PLC
PLC = snap7.client.Client()

#Parámetros de funcionamiento
temp_min = 0 #en ºC
temp_max = 30 #en ºC
humedad_min = 20 #en %
humedad_max = 70 #en %

#=== FUNCIONES ===
def conectar(IP,RACK,SLOT):
    PLC.connect(IP,RACK,SLOT)

def desconectar():
    PLC.disconnect()

def leer_DB(n_DB, offset, cant_bytes):
    db = ""
    try:
        conectar(IP,RACK,SLOT)
        db = PLC.db_read(n_DB, offset, cant_bytes)
    except snap7.snap7exceptions.Snap7Exception:
        desconectar()
        print("Lectura imposible, revisar PLC")
        return("Lectura imposible, revisar PLC")
    desconectar()
    return db



#=== CODIGO ===
#PARAMETRIZACIÓN INICIAL
temp_min = input('Temperatura mínima(ºC): ') #en ºC
temp_max = input('Temperatura máxima(ºC): ') #en ºC
humedad_min = input('Humedad mínima(%): ') #en %
humedad_max = input('Humedad máxima(%): ') #en %

#BUCLE DE ACTUALIZACION DE LOS DATOS
while True:
    #Reseteamos el valor del zumbador para este ciclo
    zumbador = False

    #db = leer_DB(300,0,1)
    db = bytearray(b'\x00\x00\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe4\x0c\x16\x03\t.\x16\x01\xd4\xbc\x18\x07\xe4\x0c\x16\x03\n\x024 =\xd8`\x00\x0f\x1c\x94\xfe\x02A4                                                                                                                                                                                                                                                            \xfe\x08Paquillo                                                                                                                                                                                                                                                      \xfe\x04Paroha\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00c\x00F\x00\x1d\x00c?5\x02\x96\xfe\nAleta DCHA                                                                                                                                                                                                                                                    \x00\x00+\x03\xfe\x02A4                                                                                                                                                                                                                                                            \xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00') 
    nuestrobool0 = snap7.util.get_bool(db, 1324, 0)
    nuestrobool2 = snap7.util.get_bool(db, 1324, 2)
    if nuestrobool0:
        print("ACTIVADO BOOL 0")
        zumbador = True
    if nuestrobool2:
        print("ACTIVADO BOOL 2")

    #TODO leemos temperatura y humedad actual
    temp_actual = 0
    humedad_actual = 0
    #TODO comparamos con los valores de la parametrización
    if temp_min > temp_actual:
        #TODO error temperatura demasiado baja, activar LED
        print("Hace frio")
    if temp_max < temp_actual:
        #TODO error temperatura demasiado alta, activar LED
        print("Hace calor")


    if zumbador:
        #TODO activar zumbador
        print("bzzzzz")
    time.sleep(tiempo_bucle)